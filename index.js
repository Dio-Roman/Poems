const express=require("express"),bodyParser=require("body-parser"),app=express(),path=require("path"),port=process.env.PORT||3e3,MongoClient=require("mongodb").MongoClient,dbPath=require("./db/dbPath"),fs=require("fs"),multer=require("multer"),mongoose=require("mongoose"),session=require("express-session"),MongoStore=require("connect-mongo")(session),User=require("./models/user"),sharp=require("sharp");var db=mongoose.connect(dbPath.auth);app.use(session({secret:"work hard",resave:!0,saveUninitialized:!1,store:new MongoStore({url:dbPath.auth})}));const storage=multer.diskStorage({destination:(e,o,r)=>{r(null,"public/img")},filename:(e,o,r)=>{r(null,o.originalname)}}),upload=multer({storage:storage});var dbase;const handleError=(e,o)=>{o.status(500).contentType("text/plain").end("Oops! Something went wrong!")};MongoClient.connect(dbPath.mongo,(e,o)=>{if(e)return console.log(e);dbase=o.db("poems")}),app.listen(port,()=>{console.log("listening on 3000")}),app.set("view engine","pug"),app.set("views","./views"),app.use("/static",express.static("public")),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!1})),app.get("/",(e,o)=>{dbase.collection("poems").find().toArray((e,r)=>{if(e)return console.log(e);o.render("index.pug",{mongo:r})})}),app.get("/about",(e,o)=>{o.render("about.pug")}),app.get("/add",(e,o)=>{dbase.collection("poems").find().toArray((e,r)=>{if(e)return console.log(e);o.render("add.pug",{countPoems:r.length})})});const ObjectID=require("mongodb").ObjectID;app.get("/:id",(e,o)=>{const r=e.params.id,s={_id:new ObjectID(r)};dbase.collection("poems").find(s).toArray((e,r)=>{if(e)return console.log(e);o.render("card.pug",{mongo:r})})}),app.post("/upload",upload.single("file"),(e,o,r)=>{sharp(e.file.path).resize(208).toFile(`public/img/small-${e.file.originalname}`),dbase.collection("poems").save(e.body,(e,r)=>{if(e)return console.log(e);o.redirect("/")})}),app.post("/uploadone",upload.single("file"),(e,o,r)=>{dbase.collection("poems").save(e.body,(e,r)=>{if(e)return console.log(e);o.redirect("/")})}),app.post("/",function(e,o,r){var s;return e.body.password!==e.body.passwordConf?((s=new Error("Passwords do not match.")).status=400,o.send("passwords dont match"),r(s)):e.body.logemail&&e.body.logpassword?void User.authenticate(e.body.logemail,e.body.logpassword,function(s,n){if(s||!n){var t=new Error("Wrong email or password.");return t.status=401,r(t)}return e.session.userId=n._id,o.redirect("/add")}):((s=new Error("All fields required.")).status=400,r(s))}),app.get("/logout",function(e,o,r){e.session&&e.session.destroy(function(e){return e?r(e):o.redirect("/")})});