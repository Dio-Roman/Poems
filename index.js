const express=require('express'),bodyParser=require('body-parser'),app=express(),path=require('path'),port=process.env.PORT||3e3,MongoClient=require('mongodb').MongoClient,dbPath=require('./db/dbPath'),fs=require('fs'),multer=require('multer'),mongoose=require('mongoose'),session=require('express-session'),MongoStore=require('connect-mongo')(session),User=require('./models/user');var db=mongoose.connect(dbPath.auth);app.use(session({secret:'work hard',resave:!0,saveUninitialized:!1,store:new MongoStore({url:dbPath.auth})}));const storage=multer.diskStorage({destination:(a,b,c)=>{c(null,'public/img')},filename:(a,b,c)=>{c(null,b.originalname)}}),upload=multer({storage:storage});var dbase;const handleError=(a,b)=>{b.status(500).contentType('text/plain').end('Oops! Something went wrong!')};MongoClient.connect(dbPath.mongo,(a,b)=>{return a?console.log(a):void(dbase=b.db('poems'))}),app.listen(port,()=>{console.log('listening on 3000')}),app.set('view engine','pug'),app.set('views','./views'),app.use('/static',express.static('public')),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!1})),app.get('/',(a,b)=>{dbase.collection('poems').find().toArray((c,d)=>{return c?console.log(c):void b.render('index.pug',{mongo:d})})}),app.get('/about',(a,b)=>{b.render('about.pug')}),app.get('/add',(a,b)=>{b.render('add.pug')});const ObjectID=require('mongodb').ObjectID;app.get('/:id',(a,b)=>{const c=a.params.id,d={_id:new ObjectID(c)};dbase.collection('poems').find(d).toArray((e,f)=>{return e?console.log(e):void b.render('card.pug',{mongo:f})})}),app.post('/upload',upload.single('file'),(a,b)=>{dbase.collection('poems').save(a.body,c=>{return c?console.log(c):void b.redirect('/')})}),app.post('/',function(a,b,c){if(a.body.password!==a.body.passwordConf){var d=new Error('Passwords do not match.');return d.status=400,b.send('passwords dont match'),c(d)}if(a.body.logemail&&a.body.logpassword)User.authenticate(a.body.logemail,a.body.logpassword,function(e,f){if(e||!f){var g=new Error('Wrong email or password.');return g.status=401,c(g)}return a.session.userId=f._id,b.redirect('/add')});else{var d=new Error('All fields required.');return d.status=400,c(d)}}),app.get('/logout',function(a,b,c){a.session&&a.session.destroy(function(d){return d?c(d):b.redirect('/')})});